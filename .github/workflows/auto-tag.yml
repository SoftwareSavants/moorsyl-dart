name: Auto Tag SDK Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'sdk/auto-update'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          fetch-depth: 0

      - name: Determine bump type
        id: bump
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -q '"release:major"'; then
            echo "type=major" >> "$GITHUB_OUTPUT"
          elif echo "$LABELS" | grep -q '"release:minor"'; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
          else
            echo "type=patch" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute new version
        id: version
        run: |
          CURRENT="$(git tag --sort=-v:refname | sed -n '1p' | sed 's/^v//' | cut -d'+' -f1)"
          [ -n "$CURRENT" ] || CURRENT="0.0.0"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "${{ steps.bump.outputs.type }}" in
            major) NEW="$((MAJOR + 1)).0.0" ;;
            minor) NEW="$MAJOR.$((MINOR + 1)).0" ;;
            *) NEW="$MAJOR.$MINOR.$((PATCH + 1))" ;;
          esac
          echo "new_version=$NEW" >> "$GITHUB_OUTPUT"

      - name: Update pubspec version
        run: |
          NEW="${{ steps.version.outputs.new_version }}"
          python3 - <<PY
          from pathlib import Path
          new_version = "${NEW}"
          p = Path("pubspec.yaml")
          lines = p.read_text().splitlines()
          out = []
          done = False
          for line in lines:
            if not done and line.startswith("version:"):
              out.append(f"version: {new_version}")
              done = True
            else:
              out.append(line)
          p.write_text("\\n".join(out) + "\\n")
          PY

      - name: Update CHANGELOG.md from PR body
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          CHANGELOG_FILE="CHANGELOG.md"

          if [ ! -f "$CHANGELOG_FILE" ]; then
            printf "# Changelog\n\n" > "$CHANGELOG_FILE"
          fi

          CHANGELOG_SECTION="$(printf '%s\n' "$PR_BODY" | awk '
            BEGIN{capture=0}
            /^##[[:space:]]+Changelog[[:space:]]*$/ {capture=1; next}
            /^##[[:space:]]+/ && capture==1 {exit}
            capture==1 {print}
          ' | sed '/^[[:space:]]*$/d')"

          if [ -z "$CHANGELOG_SECTION" ]; then
            CHANGELOG_SECTION="- SDK update from merged PR #${{ github.event.pull_request.number }}."
          fi

          {
            printf "# Changelog\n\n"
            printf "## %s\n\n" "$VERSION"
            printf "%s\n\n" "$CHANGELOG_SECTION"
            awk 'NR>1' "$CHANGELOG_FILE" 2>/dev/null || true
          } > /tmp/CHANGELOG.new

          mv /tmp/CHANGELOG.new "$CHANGELOG_FILE"

      - name: Commit + tag
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          git config user.name "Moorsyl Bot"
          git config user.email "bot@moorsyl.com"
          git add pubspec.yaml CHANGELOG.md
          git commit -m "chore: release v$VERSION"
          git tag "v$VERSION"
          git push origin HEAD:refs/heads/sdk/auto-update
          git push origin main
          git push origin "v$VERSION"
